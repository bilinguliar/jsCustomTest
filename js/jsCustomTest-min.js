/**
 * Created with IntelliJ IDEA.
 * User: xmapact
 * Date: 1/25/14
 * Time: 7:57 PM
 */

var userTest={settings:{dataFile:"jsCustomTest.xml",formListener:"submit.php",targetDiv:"jsCustomTest",showQuestionsOneByOne:{enabled:true,mode:"hide"},useDefaultResult:true,calculation:"popular",resultPage:"HTMLPage",selfDestruction:{enabled:true,destructionTimer:5e3}},getData:function(){function t(e,t){function n(e){function t(t){for(var n=0;n<t.length;n+=1){try{userTest.local[t[n]]=e.getElementsByTagName(t[n])[0].firstChild.data}catch(r){console.log("Error accessing data file element with tag:"+t[n])}}}var n=["name","header","resultHeader","silentResult"];t(n);var r=e.getElementsByTagName("question");userTest.qstAmount=r.length;for(var i=0,s=r.length;i<s;i+=1){var o=r[i].getAttribute("name"),u={};u.name=o;for(var a=r[i].firstChild;a!=null;a=a.nextSibling){if(a.tagName=="text"){u.questionText=a.firstChild.data}if(a.tagName=="picture"){if(a.firstChild!=null){u.pictureSource=a.firstChild.data}}}u.answers=[];for(var f=r[i].firstChild;f!=null;f=f.nextSibling){if(f.tagName=="answers"){for(var l=f.firstChild;l!=null;l=l.nextSibling){if(l.tagName=="answer"){var c,h,p=null;if(l.getAttribute("name")){p=l.getAttribute("name");h={};h.name=p}else{throw"Exception: Name attribute is not provided for an answer."}switch(userTest.settings.calculation){case"popular":{}break;case"score":{if(l.getAttribute("score")){c=l.getAttribute("score");h.score=c}else{throw"Exception: Score attribute is not provided for an answer."}}break;case"comb":{if(l.getAttribute("comb")){c=l.getAttribute("comb");h.comb=c}else{throw"Exception: Comb attribute is not provided for an answer."}}break;default:throw"Exception: userTest.settings.calculation method is unsupported"}if(l.firstChild.data){h.answerText=l.firstChild.data}else{throw"Exception: Label for answer "+p+" in question"+o+" is empty"}u.answers.push(h)}}}}userTest.localQst.push(u)}var d=e.getElementsByTagName("result");if(!d){throw"Exception: Was not able to find results in data file."}for(var v=0,m=d.length;v<m;v+=1){var g=d[v].getAttribute("name");if(!d[v].getAttribute("name")){throw"Exception: Required name attribute is missing for at least one of results in data file"}userTest.localAnsw[g]={minScore:d[v].getAttribute("minScore"),maxScore:d[v].getAttribute("maxScore"),comb:d[v].getAttribute("comb"),links:[]};for(var y=d[v].firstChild;y!=null;y=y.nextSibling){switch(y.tagName){case"HTMLPage":{if(y.firstChild!=null){userTest.localAnsw[g].HTMLPage=y.firstChild.data}}break;case"redirect":{if(y.firstChild!=null){userTest.localAnsw[g].redirect=y.firstChild.data}}break;default:{}}}}}function r(e){userTest.local=e["test"].local;userTest.localQst=e["test"]["questions"];userTest.localAnsw=e["test"]["results"];userTest.qstAmount=0;for(var t in userTest.localQst){if(userTest.localQst.hasOwnProperty(t)){userTest.qstAmount+=1}}}switch(t){case"xml":{n(e)}break;case"json":{r(e)}break;default:{throw"Exception: Data file type unknown: '"+t+"' currently only XML and JSON are supported."}}if(userTest.settings.useDefaultResult&&!userTest.localAnsw["default"]){throw"Exception: 'useDefaultResult' is set to true but default result is not present in data file."}userTest.place()}userTest.local={};userTest.localAnsw={};userTest.localQst=[];userTest.targetDiv=$("#"+userTest.settings.targetDiv);if(userTest.targetDiv[0]==undefined){throw"Exception: Can not find DIV to render quiz. "+"Current setting is: 'targetDiv': '"+userTest.settings.targetDiv+"'."}var e=userTest.settings.dataFile.toLowerCase().substring(userTest.settings.dataFile.lastIndexOf(".")+1);$.post(userTest.settings.dataFile,function(n){t(n,e)},e)},place:function(){var e=$(document.createElement("div")).attr("id","testBodyDiv"),t=$(document.createElement("div")).attr("id","progressbar"),n=$(document.createDocumentFragment()),r=userTest.local.name,i=0;for(var s in userTest.localQst){if(!userTest.localQst.hasOwnProperty(s)){continue}i+=1;var o=$(document.createElement("div")).attr("id",s);var u=[];u.push("question",i%2==0?"questionOdd":"questionEven");if(i==1){u.push("questionFirst")}else if(i==userTest.qstAmount){u.push("questionLast")}o.addClass(u.join(" "));var a=$(document.createElement("span")).append(i+".");o.append($(document.createElement("h3")).text(userTest.localQst[s].questionText).prepend(a).on("click",userTest.toggleVis));var f=$(document.createElement("div")).addClass("question_wrapper");if(userTest.settings.showQuestionsOneByOne.enabled&&i!=1){switch(userTest.settings.showQuestionsOneByOne.mode){case"collapse":{f.css("display","none")}break;case"hide":{o.css("display","none")}break;default:{throw"Exception: unknown mode in 'userTest.settings.showQuestionsOneByOne.mode'"}}}if(typeof userTest.localQst[s].pictureSource!="undefined"){f.append($(document.createElement("img")).attr("src",userTest.localQst[s].pictureSource))}e.append(o);var l=$(document.createElement("ul")).attr("id",s+"List");f.append(l);o.append(f);for(var c in userTest.localQst[s].answers){if(userTest.localQst[s].answers.hasOwnProperty(c)){var h=userTest.localQst[s].answers[c]["answerText"],p=$(document.createElement("label")),d=null,v;switch(userTest.settings.calculation){case"popular":{v=userTest.localQst[s].answers[c].name}break;case"score":{v=userTest.localQst[s].answers[c].score}break;case"comb":{v=userTest.localQst[s].answers[c].comb}break;default:throw"Exception: userTest.settings.calculation method is unsupported"}var m=s+"_"+c;if(!d){d=$(document.createElement("input")).attr({type:"radio",name:s,value:v,id:m})}$(d).on("click",userTest.analyze).on("click",userTest.toggleVis);p.text(h).attr("for",m);var g=$(document.createElement("li")).append(d).append(p);l.append(g)}}}var y=$(document.createElement("h2")).attr("id","testHeaderH2");y.append(r);n.append(y).append(t).append(e);userTest.targetDiv.append(n)},analyze:function(e){var t=userTest.settings.calculation,n=$("#progressbar"),r=$("#testHeaderH2"),i;if($("#progresscol").length==0){n.append($(document.createElement("div")).attr("id","progresscol"))}$(e.target).closest(".question").find("h3:first").addClass("answered");if(userTest.settings.showQuestionsOneByOne.enabled){switch(userTest.settings.showQuestionsOneByOne.mode){case"collapse":{$("#"+$(e.target).closest(".question")[0].id).next().find(".question_wrapper").slideDown()}break;case"hide":{$("#"+$(e.target).closest(".question")[0].id).next(".question").slideDown()}break;default:{}}}if(!userTest[t]){userTest[t]={}}userTest[t][this.name]=this.value;userTest.qstDone=0;for(var s in userTest[t]){if(userTest[t].hasOwnProperty(s)){userTest.qstDone+=1}}i=userTest.local.header+" "+(userTest.qstAmount-userTest.qstDone);if(userTest.qstAmount==userTest.qstDone){i=userTest.local["resultHeader"];r.text(i);n.hide();userTest.result()}if(r.length>0){r.fadeOut("fast",function(){$(this).text(i).fadeIn("fast")});$("#progresscol").animate({width:100-(userTest.qstAmount-userTest.qstDone)/(userTest.qstAmount/100)+"%"})}else{r.append($(document.createElement("h2")).text(i));$("#progresscol").css({width:"0"})}},result:function(){var e,t;switch(userTest.settings.calculation){case"popular":{t={};for(e in userTest["popular"]){if(userTest["popular"].hasOwnProperty(e)){t[userTest["popular"][e]]?t[userTest["popular"][e]]+=1:t[userTest["popular"][e]]=1}}var n=0;for(var r in t){if(t.hasOwnProperty(r)){if(t[r]>n){n=t[r];e=r}}}userTest.resultVariantObject=userTest.localAnsw[e]}break;case"score":{t=0;for(var i in userTest.score){if(userTest.score.hasOwnProperty(i)){t+=parseInt(userTest.score[i])}}for(e in userTest.localAnsw){if(userTest.localAnsw.hasOwnProperty(e)){if(t>=userTest.localAnsw[e]["minScore"]&&t<=userTest.localAnsw[e]["maxScore"]){userTest.resultVariantObject=userTest.localAnsw[e]}}}}break;case"comb":{t="";for(var s in userTest.comb){if(userTest.comb.hasOwnProperty(s)){t+=userTest.comb[s]}}for(e in userTest.localAnsw){if(userTest.localAnsw.hasOwnProperty(e)){if(t==userTest.localAnsw[e].comb){userTest.resultVariantObject=userTest.localAnsw[e]}}}}break}userTest.resultVariant=e;var o;switch(userTest.settings.resultPage){case"HTMLPage":{userTest.doResultCheck();if(!userTest.resultVariantObject.HTMLPage){throw"Exception: HTMLPage is current result rendering setting, "+"but no source set in data file '"+userTest.settings.dataFile+"'"}$.post(userTest.resultVariantObject.HTMLPage,function(e){o=$(e).filter("#resultNode").html();userTest.targetDiv.fadeOut("fast",function(){$(this).find("#testHeaderH2").remove();$(this).find("#testBodyDiv").remove();if(o==undefined){throw"Exception: HTML result page '"+userTest.resultVariantObject.HTMLPage+"' is not accessible or doesn't have DIV with id='resultNode'"}$(this).append(o);$(this).fadeIn("fast")})});$.post(userTest.settings.formListener,{result:userTest.resultVariant})}break;case"redirect":{$.post(userTest.settings.formListener,{result:userTest.resultVariant});window.location=userTest.resultVariantObject.redirect}break;case"silent":{o=$(document.createElement("div")).attr("id","testResultDiv").append($(document.createElement("p")).attr("id","testResultP").text(userTest.local["loadingText"]));userTest.targetDiv.find("#testHeaderH2").remove();userTest.targetDiv.find("#testBodyDiv").remove();userTest.targetDiv.append(o);var u,a;u={result:userTest.resultVariant};a=function(){$("#testResultP").text(userTest.local["silentResult"])};$.post(userTest.settings.formListener,u,a);if(userTest.settings.selfDestruction.enabled){function f(){userTest.targetDiv.remove()}setTimeout(f,userTest.settings.selfDestruction.destructionTimer)}}break;default:{throw"Exception: Result page type unknown: '"+userTest.settings.resultPage+"'."}}},restart:function(){userTest.targetDiv.empty();userTest[userTest.settings.calculation]={};userTest.place()},toggleVis:function(e){var t=e.target;t=t.tagName.toUpperCase()=="INPUT"||t.tagName.toUpperCase()=="LABEL"?$(t).parents(".question_wrapper"):$(t).next(".question_wrapper");if(t.length>0){t.slideToggle()}},doResultCheck:function(){if(!userTest.resultVariantObject){if(userTest.settings.useDefaultResult){userTest.resultVariantObject=userTest.localAnsw["default"]}else{var e="No result option for such a unique answers combination.";alert(e);throw e}}},init:function(){userTest.getData()}};$(userTest.init)
